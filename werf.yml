configVersion: 1
project: heyka-backend
deploy:
  helmRelease: "[[ project ]]-[[ env ]]"
  namespace: "heyka-[[ env ]]"

---
image: backend
from: node:alpine
docker:
  ENV:
    LANG: C.UTF-8
git:
- add: /
  to: /app
  excludePaths:
  - .helm
  - werf.yaml
  - .github
  stageDependencies:
    install:
    - "package.json"
    - "yarn.lock"
    setup:
    - "**/*"
ansible:
  beforeInstall:
  - name: "Install dependencies"
    apk:
      name:
        postgresql-client
  install:
  - name: Add node-gyp
    shell: apk add --no-cache --virtual .build-deps alpine-sdk python && npm install --global node-gyp && apk del .build-deps
  - name: Install packages
    shell: yarn
    args:
      chdir: /app
  setup:
  - name: Install ynadex cert for mdb
    shell: |
      mkdir -p ~/.postgresql
      wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.postgresql/root.crt
      chmod 0600 ~/.postgresql/root.crt
