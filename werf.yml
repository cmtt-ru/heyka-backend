configVersion: 1
project: heyka-backend
deploy:
 helmRelease: "[[ project ]]-[[ env ]]"
 namespace: "heyka-[[ env ]]"

---
image: backend
from: node:alpine
docker:
  ENV:
    LANG: C.UTF-8
git:
  - add: /
    to: /app
    stageDependencies:
      install:
      - "package.json"
      - "yarn.lock"
      setup:
      - "**/*"
ansible:
  install:
   - name: Install packages
     shell: yarn
     args:
       chdir: /app
  setup:
    - name: Install ynadex cert for mdb
      shell: |
        mkdir -p ~/.postgresql
        wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.postgresql/root.crt
        chmod 0600 ~/.postgresql/root.crt


---
image: janus-docker
dockerfile: docker/janus/Dockerfile
context: docker/janus/

---
image: janus
fromImage: janus-docker
git:
  - add: /.werffiles/entrypoint.sh
    to: /entrypoint.sh
    stageDependencies:
      setup:
        - "**/*"
ansible:
  beforeSetup:
    - name: install common packages
      apt:
        update_cache: yes
        state: present
        name: [
          'tzdata',
          'curl'
        ]
    - name: "Set timezone"
      timezone:
        name: Europe/Moscow
  setup:
    - name: "Change rights for scripts"
      file:
        path: "/entrypoint.sh"
        mode: 0755
